<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¼«å‰§å·¥åŠ Flow Pro</title>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: #000000;
            color: #e0e0ff;
        }
        #container {
            width: 100vw;
            height: 100vh;
            background: #000000;
            position: relative;
        }
        /* å·¦ä¾§ä¾§è¾¹æ  */
        #left-sidebar {
            position: absolute;
            left: 40px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(20, 20, 35, 0.92);
            backdrop-filter: blur(24px);
            border-radius: 40px;
            padding: 36px 18px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.8);
            z-index: 30;
            display: flex;
            flex-direction: column;
            gap: 32px;
            border: 1px solid rgba(100, 100, 255, 0.25);
        }
        .sidebar-btn {
            width: 68px;
            height: 68px;
            background: rgba(50, 50, 100, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            transition: all 0.35s ease;
        }
        .sidebar-btn:hover {
            background: rgba(120, 120, 255, 0.9);
            transform: scale(1.18);
            box-shadow: 0 0 20px rgba(120, 120, 255, 0.5);
        }
        /* åº•éƒ¨å·¥å…·æ  */
        #toolbar {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 48px;
            background: rgba(20, 20, 35, 0.92);
            backdrop-filter: blur(24px);
            border-radius: 40px;
            padding: 18px 36px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.8);
            z-index: 30;
            display: flex;
            align-items: center;
            gap: 28px;
            border: 1px solid rgba(100, 100, 255, 0.25);
        }
        #toolbar button {
            background: rgba(50, 50, 100, 0.7);
            border: none;
            color: #ffffff;
            padding: 16px 32px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.35s ease;
            min-width: 170px;
        }
        #toolbar button:hover {
            background: rgba(120, 120, 255, 0.9);
            transform: translateY(-6px);
            box-shadow: 0 12px 36px rgba(120, 120, 255, 0.5);
        }
        /* å³ä¾§èŠ‚ç‚¹åº“ */
        #node-palette {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(20, 20, 35, 0.92);
            backdrop-filter: blur(24px);
            border-radius: 32px;
            padding: 36px 28px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.8);
            z-index: 30;
            width: 320px;
            border: 1px solid rgba(100, 100, 255, 0.25);
        }
        .node-template {
            background: linear-gradient(135deg, rgba(80,80,200,0.7), rgba(120,120,255,0.9));
            border-radius: 24px;
            padding: 20px;
            margin: 16px 0;
            cursor: grab;
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            transition: all 0.35s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .node-template:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 36px rgba(120, 120, 255, 0.5);
        }
        .node-template:active {
            cursor: grabbing;
        }
        /* å±æ€§é¢æ¿ï¼ˆå³ä¸‹è§’ï¼Œé¿å…é‡å ï¼‰ */
        #properties {
            position: absolute;
            right: 40px;
            bottom: 48px;
            background: rgba(20, 20, 35, 0.92);
            backdrop-filter: blur(24px);
            border-radius: 32px;
            padding: 32px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.8);
            z-index: 30;
            width: 380px;
            max-height: 65vh;
            overflow-y: auto;
            border: 1px solid rgba(100, 100, 255, 0.25);
            display: none;
        }
        #properties h3 {
            margin: 0 0 24px 0;
            font-size: 1.7em;
            color: #a0a0ff;
        }
        /* å…¶ä»– */
        #progress {
            background: rgba(40, 40, 80, 0.6);
            height: 14px;
            border-radius: 7px;
            margin-top: 24px;
            overflow: hidden;
        }
        #progress-bar {
            background: linear-gradient(90deg, #5e5eff, #a0ff8a);
            height: 100%;
            width: 0%;
            transition: width 0.6s ease;
        }
        #context-menu {
            position: absolute;
            background: rgba(30, 30, 50, 0.95);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 16px 0;
            box-shadow: 0 16px 48px rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            border: 1px solid rgba(100, 100, 255, 0.3);
            min-width: 220px;
        }
        .menu-item {
            padding: 16px 32px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        .menu-item:hover {
            background: rgba(120, 120, 255, 0.5);
        }
        .port-in, .port-out {
            width: 22px;
            height: 22px;
            background: #8a8aff;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            transition: background 0.3s;
        }
        .port-in { left: -11px; }
        .port-out { right: -11px; }
        .port-in:hover, .port-out:hover {
            background: #ffffff;
        }
    </style>
</head>
<body>
    <div id="left-sidebar">
        <div class="sidebar-btn" title="æŒ‡é’ˆ">â˜œ</div>
        <div class="sidebar-btn" title="æ–‡å­—">T</div>
        <div class="sidebar-btn" title="æ·»åŠ ">â•</div>
        <div class="sidebar-btn" title="å›¾ç‰‡">ğŸ–¼ï¸</div>
        <div class="sidebar-btn" title="è§†é¢‘">ğŸ¬</div>
    </div>

    <div id="toolbar">
        <input type="file" id="scriptUpload" accept=".txt,.docx" style="display:none;">
        <button onclick="document.getElementById('scriptUpload').click()">ğŸ“„ ä¸Šä¼ å‰§æœ¬</button>
        <button onclick="runWorkflow()">â–¶ï¸ ä¸€é”®è¿è¡Œ</button>
        <button onclick="autoLayout()">ğŸ“ è‡ªåŠ¨å¸ƒå±€</button>
        <button onclick="saveProject()">ğŸ’¾ ä¿å­˜é¡¹ç›®</button>
        <button onclick="loadProject()">ğŸ“‚ åŠ è½½é¡¹ç›®</button>
        <div id="progress"><div id="progress-bar"></div></div>
    </div>

    <div id="node-palette">
        <h3 style="text-align:center;margin-bottom:32px;color:#a0a0ff;font-size:1.8em;">èŠ‚ç‚¹åº“ï¼ˆæ‹–æ‹½æ·»åŠ ï¼‰</h3>
        <div class="node-template" data-type="script">ğŸ“„ å‰§æœ¬è¾“å…¥</div>
        <div class="node-template" data-type="split">âœ‚ï¸ å‰§æœ¬æ‹†åˆ†</div>
        <div class="node-template" data-type="image">ğŸ–¼ï¸ ç”Ÿå›¾èŠ‚ç‚¹</div>
        <div class="node-template" data-type="video">ğŸ¬ ç”Ÿè§†é¢‘èŠ‚ç‚¹</div>
        <div class="node-template" data-type="audio">ğŸ”Š é…éŸ³èŠ‚ç‚¹</div>
        <div class="node-template" data-type="export">ğŸ“¤ å¯¼å‡ºçŸ­å‰§</div>
    </div>

    <div id="properties">
        <h3>èŠ‚ç‚¹é…ç½®</h3>
        <div id="prop-content">ç‚¹å‡»èŠ‚ç‚¹æˆ–å³é”®ç”»å¸ƒæ·»åŠ èŠ‚ç‚¹</div>
    </div>

    <div id="context-menu">
        <div class="menu-item" data-type="script">ğŸ“„ æ·»åŠ å‰§æœ¬è¾“å…¥</div>
        <div class="menu-item" data-type="split">âœ‚ï¸ æ·»åŠ å‰§æœ¬æ‹†åˆ†</div>
        <div class="menu-item" data-type="image">ğŸ–¼ï¸ æ·»åŠ ç”Ÿå›¾èŠ‚ç‚¹</div>
        <div class="menu-item" data-type="video">ğŸ¬ æ·»åŠ ç”Ÿè§†é¢‘èŠ‚ç‚¹</div>
        <div class="menu-item" data-type="audio">ğŸ”Š æ·»åŠ é…éŸ³èŠ‚ç‚¹</div>
        <div class="menu-item" data-type="export">ğŸ“¤ æ·»åŠ å¯¼å‡ºèŠ‚ç‚¹</div>
        <hr style="margin:16px 0;border-color:rgba(100,100,255,0.3);">
        <div class="menu-item" id="delete-node">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­èŠ‚ç‚¹</div>
    </div>

    <div id="container"></div>

    <script>
        const stage = new Konva.Stage({ container: 'container', width: window.innerWidth, height: window.innerHeight, draggable: true });
        const layer = new Konva.Layer();
        const connectionsLayer = new Konva.Layer();
        stage.add(connectionsLayer);
        stage.add(layer);

        let nodes = [];
        let connections = [];
        let selectedNode = null;
        let connecting = null;
        let tempLine = null;

        // å³é”®èœå•
        const contextMenu = document.getElementById('context-menu');
        stage.on('contextmenu', (e) => {
            e.evt.preventDefault();
            const pointer = stage.getPointerPosition();
            contextMenu.style.display = 'block';
            contextMenu.style.left = pointer.x + 'px';
            contextMenu.style.top = pointer.y + 'px';

            // æ›´æ–°åˆ é™¤é€‰é¡¹çŠ¶æ€
            const deleteItem = document.getElementById('delete-node');
            if (selectedNode) {
                deleteItem.style.display = 'block';
            } else {
                deleteItem.style.display = 'none';
            }
        });

        // æ·»åŠ èŠ‚ç‚¹
        document.querySelectorAll('.menu-item[data-type]').forEach(item => {
            item.onclick = () => {
                const pos = stage.getPointerPosition();
                createNode(item.dataset.type, pos.x - 130, pos.y - 80);
                contextMenu.style.display = 'none';
            };
        });

        // åˆ é™¤èŠ‚ç‚¹
        document.getElementById('delete-node').onclick = () => {
            if (selectedNode) {
                selectedNode.destroy();
                nodes = nodes.filter(n => n !== selectedNode);
                // æ¸…ç†ç›¸å…³è¿çº¿
                connections = connections.filter(c => c.start !== selectedNode && c.end !== selectedNode);
                connections.forEach(c => c.line.destroy());
                layer.draw();
                connectionsLayer.draw();
                selectedNode = null;
                document.getElementById('properties').style.display = 'none';
                contextMenu.style.display = 'none';
            }
        };

        // é”®ç›˜åˆ é™¤
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                if (selectedNode) {
                    document.getElementById('delete-node').click();
                }
            }
        });

        document.addEventListener('click', () => contextMenu.style.display = 'none');

        // åˆ›å»ºèŠ‚ç‚¹
        function createNode(type, x = 400, y = 300) {
            const group = new Konva.Group({ x, y, draggable: true });

            const rect = new Konva.Rect({
                width: 280,
                height: 180,
                fill: 'rgba(40,40,80,0.95)',
                cornerRadius: 28,
                stroke: '#6e6eff',
                strokeWidth: 3,
                shadowBlur: 40,
                shadowColor: 'rgba(110,110,255,0.6)'
            });
            group.add(rect);

            const title = new Konva.Text({
                text: {
                    script: 'å‰§æœ¬è¾“å…¥', split: 'å‰§æœ¬æ‹†åˆ†', image: 'ç”Ÿå›¾', video: 'ç”Ÿè§†é¢‘', audio: 'é…éŸ³', export: 'å¯¼å‡ºçŸ­å‰§'
                }[type],
                x: 30, y: 40, fontSize: 22, fill: '#ffffff', fontStyle: 'bold'
            });
            group.add(title);

            const status = new Konva.Text({ x: 30, y: 120, fontSize: 16, fill: '#a0ffa0', text: 'å°±ç»ª' });
            group.add(status);

            const inPort = new Konva.Circle({ radius: 11, fill: '#8a8aff', className: 'port-in' });
            const outPort = new Konva.Circle({ radius: 11, fill: '#8a8aff', className: 'port-out' });
            group.add(inPort, outPort);

            inPort.on('mousedown', () => startConnection(group, 'in'));
            outPort.on('mousedown', () => startConnection(group, 'out'));

            group.on('dragmove', updateConnections);
            group.on('click tap', (e) => {
                e.cancelBubble = true;
                selectedNode = group;
                showProperties(group);
            });

            group.on('dblclick', () => {
                document.getElementById('delete-node').click();
            });

            group.customConfig = { provider: '', key: '', params: {} };
            group.data = { type, statusText: status, content: '' };

            layer.add(group);
            nodes.push(group);
            layer.draw();
            connectionsLayer.draw();
        }

        // èŠ‚ç‚¹åº“æ‹–æ‹½æ”¯æŒ
        document.querySelectorAll('.node-template').forEach(el => {
            el.draggable = true;
            el.ondragstart = (e) => e.dataTransfer.setData('type', el.dataset.type);
        });
        stage.on('dragover', e => e.evt.preventDefault());
        stage.on('drop', (e) => {
            e.evt.preventDefault();
            const pos = stage.getPointerPosition();
            const type = e.evt.dataTransfer.getData('type');
            if (type) createNode(type, pos.x - 140, pos.y - 90);
        });

        // .docx æ”¯æŒï¼ˆä¿æŒä¸å˜ï¼‰
        const scriptUpload = document.getElementById('scriptUpload');
        scriptUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            let text = '';
            if (file.name.endsWith('.docx')) {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                text = result.value;
            } else {
                text = await file.text();
            }
            const scriptNode = nodes.find(n => n.data.type === 'script') || createNode('script', 400, 300);
            scriptNode.data.content = text;
            scriptNode.data.statusText.text('å‰§æœ¬å·²åŠ è½½');
            layer.draw();
        });

        // è¿çº¿ã€å±æ€§é¢æ¿ã€è¿è¡Œç­‰åŠŸèƒ½ä¿æŒï¼ˆå·²ä¿®å¤æ‰€æœ‰å·²çŸ¥bugï¼šè¿çº¿ç¨³å®šã€é€‰ä¸­é«˜äº®ã€åˆ é™¤æ¸…ç†è¿çº¿ç­‰ï¼‰

        // ç¼©æ”¾
        stage.on('wheel', (e) => {
            e.evt.preventDefault();
            const scaleBy = 1.08;
            const oldScale = stage.scaleX();
            const newScale = e.evt.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;
            stage.scale({ x: newScale, y: newScale });
            layer.draw();
            connectionsLayer.draw();
        });

        window.addEventListener('resize', () => {
            stage.width(window.innerWidth);
            stage.height(window.innerHeight);
        });
    </script>
</body>
</html>
