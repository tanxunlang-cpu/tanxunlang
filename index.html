<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>AI 漫剧工坊 Flow Pro</title>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { /* 同上一版主题变量 */ }
        [data-theme="light"] { /* 同上一版 */ }
        body { /* 同上一版 */ }
        /* 所有样式保持上一版优化布局 */
        /* ...（复制上一版的完整样式） */
    </style>
</head>
<body data-theme="dark">
    <!-- HTML 结构保持上一版（工具栏增加运行反馈，属性面板增加Key输入和运行按钮） -->

    <script>
        // 所有基础逻辑保持上一版（画布、节点创建、动画、连线、删除、主题/语言切换、移动适配、.docx支持）

        // 新增：真实API调用函数（以Kimi拆分为例，其他节点模拟）
        async function callKimiAPI(prompt, key) {
            if (!key) return '请在节点配置中输入Kimi API Key';
            try {
                const res = await fetch('https://api.moonshot.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'moonshot-v1-8k',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.7
                    })
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                return data.choices[0].message.content;
            } catch (e) {
                return `调用失败：${e.message}（检查Key或网络）`;
            }
        }

        // 运行单个节点（核心功能输入）
        async function runSingleNode() {
            if (!selectedNode) return alert('请先选中节点');
            const type = selectedNode.data.type;
            const cfg = selectedNode.customConfig;
            selectedNode.data.statusText.text('运行中...');
            layer.draw();

            let result = '';
            if (type === 'split' && selectedNode.data.content) { // 假设上游剧本已加载
                result = await callKimiAPI(`请将以下剧本拆分成10个分镜，每个包含描述、对白、定帧图像prompt（漫画风格）:\n${selectedNode.data.content}`, cfg.key || prompt('请输入Kimi Key（临时）'));
            } else if (type === 'image') {
                result = 'https://via.placeholder.com/1024x1024/333355/ffffff?text=生图结果（真实需Key）';
            } else if (type === 'video') {
                result = 'https://via.placeholder.com/1024x576/000000/ffffff?text=视频生成中（真实需Key）';
            }

            // 显示结果（预览图像或文本）
            const preview = document.createElement('div');
            if (type === 'image' || type === 'video') {
                const img = document.createElement('img');
                img.src = result;
                img.style.maxWidth = '100%';
                preview.appendChild(img);
            } else {
                preview.textContent = result;
            }
            document.getElementById('prop-content').appendChild(preview);

            selectedNode.data.statusText.text('完成');
            layer.draw();
        }

        // 一键运行工作流（遍历连线执行）
        function runWorkflow() {
            document.getElementById('progress-bar').style.width = '60%';
            setTimeout(() => {
                alert('工作流执行完成！（实际沿连线传递数据）');
                document.getElementById('progress-bar').style.width = '100%';
                setTimeout(() => document.getElementById('progress-bar').style.width = '0%', 1000);
            }, 2000);
        }

        // 属性面板增强：在showProperties中添加Key输入和运行按钮
        function showProperties(node) {
            // ...保持基础
            let html = `<label>API Key（此节点独立）</label>
                        <input type="password" id="node-key" value="${cfg.key}">
                        <button onclick="saveNodeConfig()">保存Key</button>
                        <button onclick="runSingleNode()">▶️ 运行此节点（真实调用）</button>`;
            // ...其他配置
        }

        // 其余逻辑保持
    </script>
</body>
</html>
