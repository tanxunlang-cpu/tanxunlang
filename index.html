<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¼«å‰§å·¥åŠ Flow</title>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: #0f0f1a;
            color: #e0e0ff;
        }
        #container {
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1a 100%);
        }
        #toolbar {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(30, 30, 50, 0.85);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            z-index: 20;
            width: 280px;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }
        #node-palette {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(30, 30, 50, 0.85);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            z-index: 20;
            width: 280px;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }
        #properties {
            position: absolute;
            right: 20px;
            bottom: 20px;
            background: rgba(30, 30, 50, 0.85);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            z-index: 20;
            width: 280px;
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }
        h3 {
            margin: 0 0 16px 0;
            font-size: 1.4em;
            color: #a0a0ff;
        }
        button, .node-template {
            background: linear-gradient(135deg, #5e5eff, #8a73ff);
            border: none;
            color: white;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 14px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            text-align: left;
        }
        button:hover, .node-template:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(138, 138, 255, 0.5);
        }
        .node-template {
            background: linear-gradient(135deg, #3a3a6e, #5e5eff);
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 12px;
            border: 1px solid rgba(100, 100, 255, 0.4);
            background: rgba(50, 50, 80, 0.6);
            color: #e0e0e0;
            font-size: 14px;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #8a8aff;
            box-shadow: 0 0 16px rgba(138, 138, 255, 0.4);
        }
        label {
            font-size: 13px;
            color: #b0b0ff;
            margin-top: 8px;
            display: block;
        }
        #progress {
            background: rgba(50, 50, 80, 0.6);
            height: 10px;
            border-radius: 5px;
            margin-top: 12px;
            overflow: hidden;
        }
        #progress-bar {
            background: linear-gradient(90deg, #5e5eff, #a0ff8a);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }
        .port-in { width: 16px; height: 16px; background: #8a8aff; border-radius: 50%; position: absolute; left: -8px; top: 50%; transform: translateY(-50%); cursor: crosshair; }
        .port-out { width: 16px; height: 16px; background: #8a8aff; border-radius: 50%; position: absolute; right: -8px; top: 50%; transform: translateY(-50%); cursor: crosshair; }
    </style>
</head>
<body>
    <div id="toolbar">
        <h3>AI æ¼«å‰§å·¥åŠ Flow</h3>
        <input type="file" id="scriptUpload" accept=".txt,.docx">
        <button onclick="toggleGlobalConfig()">âš™ï¸ å…¨å±€é»˜è®¤ API é…ç½®</button>
        <button onclick="autoLayout()">ğŸ“ è‡ªåŠ¨å¸ƒå±€</button>
        <button onclick="runWorkflow()">â–¶ï¸ ä¸€é”®è¿è¡Œå·¥ä½œæµ</button>
        <button onclick="saveProject()">ğŸ’¾ ä¿å­˜é¡¹ç›®</button>
        <button onclick="loadProject()">ğŸ“‚ åŠ è½½é¡¹ç›®</button>
        <div id="progress"><div id="progress-bar"></div></div>

        <div id="global-config" style="display:none;margin-top:16px;">
            <h3>å…¨å±€é»˜è®¤é…ç½®ï¼ˆèŠ‚ç‚¹å¯å•ç‹¬è¦†ç›–ï¼‰</h3>
            <label>é»˜è®¤æ–‡æœ¬æ¨¡å‹</label>
            <select id="global-text-provider">
                <option value="kimi" selected>Kimi K2.5</option>
                <option value="openai">OpenAI GPT-4o</option>
                <option value="grok">xAI Grok</option>
                <option value="qwen">é˜¿é‡Œ Qwen</option>
            </select>
            <label>é»˜è®¤å›¾åƒæ¨¡å‹</label>
            <select id="global-image-provider">
                <option value="nanobanana" selected>Nano Banana Pro</option>
                <option value="dalle">DALLÂ·E 3</option>
                <option value="flux">Stability Flux</option>
            </select>
            <label>é»˜è®¤è§†é¢‘æ¨¡å‹</label>
            <select id="global-video-provider">
                <option value="kling26" selected>Kling 2.6</option>
                <option value="vidu">Vidu Q2</option>
                <option value="veo">Veo 3.1</option>
                <option value="runway">Runway Gen-4</option>
            </select>
            <label>å…¨å±€é»˜è®¤ Keyï¼ˆå¯é€‰ï¼‰</label>
            <input type="password" id="global-api-key" placeholder="å¤šæ•°æ¨¡å‹å…±ç”¨">
            <button onclick="saveGlobalConfig()" style="margin-top:12px;">ä¿å­˜å…¨å±€é…ç½®</button>
        </div>
    </div>

    <div id="node-palette">
        <h3>èŠ‚ç‚¹åº“ï¼ˆæ‹–æ‹½åˆ°ç”»å¸ƒï¼‰</h3>
        <div class="node-template" data-type="script">ğŸ“„ å‰§æœ¬è¾“å…¥</div>
        <div class="node-template" data-type="split">âœ‚ï¸ å‰§æœ¬æ‹†åˆ†</div>
        <div class="node-template" data-type="image">ğŸ–¼ï¸ ç”Ÿå›¾èŠ‚ç‚¹</div>
        <div class="node-template" data-type="video">ğŸ¬ ç”Ÿè§†é¢‘èŠ‚ç‚¹</div>
        <div class="node-template" data-type="audio">ğŸ”Š ç”ŸéŸ³é¢‘èŠ‚ç‚¹</div>
        <div class="node-template" data-type="export">ğŸ“¤ å¯¼å‡ºè§†é¢‘</div>
    </div>

    <div id="properties">
        <h3>èŠ‚ç‚¹å±æ€§ï¼ˆç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹ï¼‰</h3>
        <div id="prop-content">ç‚¹å‡»ç”»å¸ƒä¸Šçš„èŠ‚ç‚¹ä»¥ç¼–è¾‘å…¶ç‹¬ç«‹é…ç½®å’Œ Prompt</div>
    </div>

    <div id="container"></div>

    <script>
        const stage = new Konva.Stage({ container: 'container', width: window.innerWidth, height: window.innerHeight, draggable: true });
        const layer = new Konva.Layer();
        const connectionsLayer = new Konva.Layer();
        stage.add(connectionsLayer);
        stage.add(layer);

        let nodes = [];
        let connections = [];
        let selectedNode = null;
        let connecting = null;
        let tempLine = null;

        // å…¨å±€é»˜è®¤é…ç½®
        let globalConfig = {
            text: 'kimi',
            image: 'nanobanana',
            video: 'kling26',
            key: ''
        };
        loadGlobalConfig();

        // åˆ›å»ºèŠ‚ç‚¹
        function createNode(type, x = 300, y = 200) {
            const group = new Konva.Group({ x, y, draggable: true });

            const rect = new Konva.Rect({
                width: 240,
                height: 140,
                fill: 'rgba(50,50,90,0.9)',
                stroke: '#8a8aff',
                strokeWidth: 3,
                cornerRadius: 20,
                shadowBlur: 20,
                shadowColor: 'rgba(138,138,255,0.5)'
            });
            group.add(rect);

            const title = new Konva.Text({
                text: {
                    script: 'å‰§æœ¬è¾“å…¥', split: 'å‰§æœ¬æ‹†åˆ†', image: 'ç”Ÿå›¾', video: 'ç”Ÿè§†é¢‘', audio: 'ç”ŸéŸ³é¢‘', export: 'å¯¼å‡º'
                }[type],
                x: 20, y: 20, fontSize: 18, fill: '#ffffff', fontStyle: 'bold'
            });
            group.add(title);

            const status = new Konva.Text({ x: 20, y: 60, fontSize: 14, fill: '#a0ffa0', text: 'å°±ç»ª' });
            group.add(status);

            const inPort = new Konva.Circle({ className: 'port-in', radius: 10, fill: '#8a8aff' });
            const outPort = new Konva.Circle({ className: 'port-out', radius: 10, fill: '#8a8aff' });
            group.add(inPort, outPort);

            inPort.on('mousedown', () => startConnection(group, 'in'));
            outPort.on('mousedown', () => startConnection(group, 'out'));

            group.on('dragmove', updateConnections);
            group.on('click tap', () => showProperties(group));

            // èŠ‚ç‚¹ä¸“å±é…ç½®ï¼ˆé»˜è®¤ç»§æ‰¿å…¨å±€ï¼Œå¯è¦†ç›–ï¼‰
            group.customConfig = {
                useGlobal: true,
                provider: type === 'split' ? globalConfig.text : type === 'image' ? globalConfig.image : type === 'video' ? globalConfig.video : '',
                key: '',
                prompt: ''
            };

            group.data = { type, statusText: status, content: '' };

            layer.add(group);
            nodes.push(group);
            layer.draw();
            connectionsLayer.draw();
        }

        // æ˜¾ç¤ºèŠ‚ç‚¹ç‹¬ç«‹å±æ€§é¢æ¿
        function showProperties(node) {
            selectedNode = node;
            const cfg = node.customConfig;
            const type = node.data.type;

            let html = `<label>èŠ‚ç‚¹ç±»å‹ï¼š${{
                script: 'å‰§æœ¬è¾“å…¥', split: 'å‰§æœ¬æ‹†åˆ†', image: 'ç”Ÿå›¾', video: 'ç”Ÿè§†é¢‘'
            }[type]}</label>`;

            if (type === 'split' || type === 'image' || type === 'video') {
                html += `
                <label><input type="checkbox" id="use-global" ${cfg.useGlobal ? 'checked' : ''}> ä½¿ç”¨å…¨å±€é»˜è®¤é…ç½®</label>
                <label>æ¨¡å‹é€‰æ‹©ï¼ˆç‹¬ç«‹è¦†ç›–ï¼‰</label>
                <select id="node-provider">
                    ${type === 'split' ? `
                        <option value="kimi" ${cfg.provider === 'kimi' ? 'selected' : ''}>Kimi K2.5</option>
                        <option value="openai" ${cfg.provider === 'openai' ? 'selected' : ''}>OpenAI GPT-4o</option>
                    ` : type === 'image' ? `
                        <option value="nanobanana" ${cfg.provider === 'nanobanana' ? 'selected' : ''}>Nano Banana Pro</option>
                        <option value="dalle" ${cfg.provider === 'dalle' ? 'selected' : ''}>DALLÂ·E 3</option>
                        <option value="flux" ${cfg.provider === 'flux' ? 'selected' : ''}>Flux</option>
                    ` : `
                        <option value="kling26" ${cfg.provider === 'kling26' ? 'selected' : ''}>Kling 2.6</option>
                        <option value="veo" ${cfg.provider === 'veo' ? 'selected' : ''}>Veo 3.1</option>
                        <option value="vidu" ${cfg.provider === 'vidu' ? 'selected' : ''}>Vidu Q2</option>
                    `}
                </select>
                <label>ç‹¬ç«‹ API Keyï¼ˆå¯é€‰ï¼‰</label>
                <input type="password" id="node-key" value="${cfg.key}" placeholder="ç•™ç©ºä½¿ç”¨å…¨å±€">
                <label>è‡ªå®šä¹‰ Promptï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="node-prompt" rows="4">${cfg.prompt}</textarea>
                <button onclick="saveNodeConfig()">ä¿å­˜èŠ‚ç‚¹é…ç½®</button>
                <button onclick="runSingleNode()">â–¶ï¸ å•ç‹¬è¿è¡Œæ­¤èŠ‚ç‚¹</button>
                `;
            }

            document.getElementById('prop-content').innerHTML = html;
            document.getElementById('properties').style.display = 'block';
        }

        function saveNodeConfig() {
            if (!selectedNode) return;
            const cfg = selectedNode.customConfig;
            cfg.useGlobal = document.getElementById('use-global')?.checked || false;
            cfg.provider = document.getElementById('node-provider')?.value || cfg.provider;
            cfg.key = document.getElementById('node-key')?.value || '';
            cfg.prompt = document.getElementById('node-prompt')?.value || '';
            alert('èŠ‚ç‚¹é…ç½®å·²ä¿å­˜');
        }

        // è¿çº¿é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼Œå®Œæ•´ç‰ˆå¯æ‰©å±•ï¼‰
        function startConnection(node, direction) {
            connecting = { node, direction };
            stage.on('mousemove', drawTempLine);
            stage.on('mouseup', () => {
                if (tempLine) tempLine.destroy();
                stage.off('mousemove mouseup');
                connecting = null;
            });
        }

        function drawTempLine(e) {
            if (!tempLine) {
                tempLine = new Konva.Arrow({ stroke: '#8a8aff', strokeWidth: 4, pointerLength: 10, pointerWidth: 10 });
                connectionsLayer.add(tempLine);
            }
            const pos = stage.getPointerPosition();
            const start = connecting.node.absolutePosition();
            const startX = connecting.direction === 'out' ? start.x + 240 : start.x;
            tempLine.points([startX, start.y + 70, pos.x, pos.y]);
            connectionsLayer.draw();
        }

        function updateConnections() {
            connectionsLayer.draw();
        }

        // èŠ‚ç‚¹åº“æ‹–æ‹½
        document.querySelectorAll('.node-template').forEach(el => {
            el.draggable = true;
            el.ondragend = (e) => {
                const pos = stage.getPointerPosition();
                if (pos) createNode(el.dataset.type, pos.x - 120, pos.y - 70);
            };
        });

        // å…¨å±€é…ç½®å‡½æ•°
        function toggleGlobalConfig() {
            const panel = document.getElementById('global-config');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function saveGlobalConfig() {
            globalConfig.text = document.getElementById('global-text-provider').value;
            globalConfig.image = document.getElementById('global-image-provider').value;
            globalConfig.video = document.getElementById('global-video-provider').value;
            globalConfig.key = document.getElementById('global-api-key').value;
            localStorage.setItem('globalAIConfig', JSON.stringify(globalConfig));
            alert('å…¨å±€é…ç½®å·²ä¿å­˜');
        }

        function loadGlobalConfig() {
            const saved = localStorage.getItem('globalAIConfig');
            if (saved) globalConfig = JSON.parse(saved);
        }

        // å…¶ä»–å‡½æ•°ï¼ˆautoLayoutã€runWorkflowã€saveProject ç­‰ï¼‰å¯åç»­æ‰©å±•
        function autoLayout() { alert('è‡ªåŠ¨å¸ƒå±€åŠŸèƒ½å¼€å‘ä¸­...'); }
        function runWorkflow() { alert('ä¸€é”®è¿è¡Œå·¥ä½œæµå¼€å‘ä¸­...'); }
        function saveProject() { alert('é¡¹ç›®ä¿å­˜å¼€å‘ä¸­...'); }
        function loadProject() { alert('é¡¹ç›®åŠ è½½å¼€å‘ä¸­...'); }

        // ç¼©æ”¾ä¸resize
        stage.on('wheel', (e) => {
            e.evt.preventDefault();
            const scaleBy = 1.05;
            const oldScale = stage.scaleX();
            const newScale = e.evt.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;
            stage.scale({ x: newScale, y: newScale });
            layer.draw(); connectionsLayer.draw();
        });

        window.addEventListener('resize', () => {
            stage.width(window.innerWidth);
            stage.height(window.innerHeight);
        });
    </script>
</body>
</html>
