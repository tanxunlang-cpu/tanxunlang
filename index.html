<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¼«å‰§å·¥åŠ Pro</title>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Roboto', Arial, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #1e1e2f 0%, #2a2a40 100%);
            color: #e0e0e0;
        }
        #container {
            width: 100vw;
            height: 100vh;
            background: rgba(20, 20, 35, 0.6);
        }
        #toolbar, #config-panel, #properties {
            position: absolute;
            background: rgba(35, 35, 55, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 10;
            width: 300px;
            border: 1px solid rgba(100, 100, 255, 0.2);
            transition: all 0.3s ease;
        }
        #toolbar { left: 20px; top: 20px; }
        #config-panel { left: 20px; top: 320px; display: none; }
        #properties { right: 20px; top: 20px; }
        h3 {
            margin: 0 0 16px 0;
            font-weight: 500;
            color: #a0a0ff;
            font-size: 1.3em;
        }
        button {
            background: linear-gradient(45deg, #5e5eff, #8a8aff);
            border: none;
            color: white;
            padding: 10px 14px;
            margin: 8px 0;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(100, 100, 255, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        select, input, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border-radius: 10px;
            border: 1px solid rgba(100, 100, 255, 0.3);
            background: rgba(50, 50, 70, 0.6);
            color: #e0e0e0;
            font-size: 14px;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #8a8aff;
            box-shadow: 0 0 12px rgba(138, 138, 255, 0.3);
        }
        label {
            font-size: 13px;
            color: #b0b0ff;
            margin-top: 12px;
            display: block;
        }
        #progress {
            background: rgba(50, 50, 70, 0.6);
            height: 8px;
            border-radius: 4px;
            margin-top: 12px;
            overflow: hidden;
        }
        #progress-bar {
            background: linear-gradient(90deg, #5e5eff, #a0ff8a);
            height: 100%;
            width: 0%;
            transition: width 0.4s ease;
        }
        #preview {
            margin-top: 12px;
            text-align: center;
        }
        #preview img, #preview video {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
        }
        .node-group .konva-text {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.6));
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <h3>AI æ¼«å‰§å·¥åŠ Pro</h3>
        <input type="file" id="scriptUpload" accept=".txt">
        <button onclick="toggleConfig()">ğŸ”§ é…ç½® API ä¸æ¨¡å‹</button>
        <button onclick="splitScript()">ğŸ“ å¤æ‚å‰§æœ¬æ‹†åˆ†ï¼ˆæ¨è Kimi K2.5ï¼‰</button>
        <button onclick="batchGenerate('image')">ğŸ–¼ï¸ æ‰¹é‡ç”Ÿå›¾ï¼ˆæ¼«ç”»é£æ ¼ï¼‰</button>
        <button onclick="batchGenerate('video')">ğŸ¬ æ‰¹é‡ç”Ÿè§†é¢‘</button>
        <button onclick="saveProject()">ğŸ’¾ ä¿å­˜é¡¹ç›®</button>
        <button onclick="loadProject()">ğŸ“‚ åŠ è½½é¡¹ç›®</button>
        <div id="progress"><div id="progress-bar"></div></div>
    </div>

    <div id="config-panel">
        <h3>API é…ç½®ä¸­å¿ƒ</h3>
        <label>æ–‡æœ¬/å‰§æœ¬æ¨¡å‹ï¼ˆå¤æ‚æ‹†åˆ†æ¨èï¼‰</label>
        <select id="text-provider">
            <option value="openai">OpenAI GPT-4o</option>
            <option value="grok">xAI Grok</option>
            <option value="qwen">é˜¿é‡Œ Qwen</option>
            <option value="kimi" selected>Moonshot Kimi K2.5ï¼ˆæœ€å¼ºå‰§æœ¬æ‹†åˆ†ï¼‰</option>
        </select>

        <label>å›¾åƒæ¨¡å‹ï¼ˆæ¨èï¼‰</label>
        <select id="image-provider">
            <option value="dalle">OpenAI DALLÂ·E 3</option>
            <option value="flux">Stability Flux</option>
            <option value="nanobanana" selected>Nano Banana Proï¼ˆGemini æœ€å¼ºå›¾åƒï¼‰</option>
        </select>

        <label>è§†é¢‘æ¨¡å‹ï¼ˆ2026 æœ€å¼ºï¼‰</label>
        <select id="video-provider">
            <option value="runway">Runway Gen-4</option>
            <option value="kling">Kling é€šç”¨</option>
            <option value="kling26" selected>Kling 2.6ï¼ˆéŸ³é¢‘åŒæ­¥ï¼‰</option>
            <option value="vidu">Vidu Q2</option>
            <option value="veo">Veo 3.1ï¼ˆGoogle æœ€å¼ºï¼‰</option>
        </select>

        <label>ä¸» API Keyï¼ˆå¤§å¤šæ•°æ¨¡å‹å…±ç”¨ï¼‰</label>
        <input type="password" id="api-key" placeholder="è¾“å…¥ä½ çš„ API Key">

        <label>å¤‡ç”¨ Keyï¼ˆå¦‚ Google Vertexï¼‰</label>
        <input type="password" id="api-key2" placeholder="å¯é€‰">

        <label>è‡ªå®šä¹‰ Endpointï¼ˆé«˜çº§ç”¨æˆ·ï¼‰</label>
        <input type="text" id="custom-endpoint" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤">

        <button onclick="saveConfig()">âœ… ä¿å­˜é…ç½®</button>
    </div>

    <div id="properties">
        <h3>èŠ‚ç‚¹ç¼–è¾‘ / é¢„è§ˆ</h3>
        <textarea id="node-prompt" rows="8" placeholder="ç¼–è¾‘ Promptï¼Œæ”¯æŒæ·»åŠ é£æ ¼æè¿°ï¼ˆå¦‚ï¼šé»‘ç™½æ¼«ç”»é£ã€é«˜ç»†èŠ‚ã€è§’è‰²ä¸€è‡´ç­‰ï¼‰"></textarea>
        <button onclick="regenerateSelected('image')">ğŸ–¼ï¸ é‡æ–°ç”Ÿå›¾</button>
        <button onclick="regenerateSelected('video')">ğŸ¬ é‡æ–°ç”Ÿè§†é¢‘</button>
        <div id="preview"></div>
    </div>

    <div id="container"></div>

    <script>
        // Konva åˆå§‹åŒ–
        const stage = new Konva.Stage({
            container: 'container',
            width: window.innerWidth,
            height: window.innerHeight,
            draggable: true
        });
        const layer = new Konva.Layer();
        stage.add(layer);

        // é…ç½®é»˜è®¤å€¼ï¼ˆå¯æ‰©å±•ï¼‰
        let config = {
            text: { provider: 'kimi', endpoint: 'https://api.moonshot.cn/v1/chat/completions', model: 'kimi-k2.5' },
            image: { provider: 'nanobanana', endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/', model: 'gemini-3-pro-image' },
            video: { provider: 'kling26', endpoint: 'https://api.klingai.com/v1/video/generate', model: 'kling-2.6' },
            key: '', key2: ''
        };
        loadConfig();

        let nodes = [];
        let selectedNode = null;

        function addNode(type, content, x = Math.random() * 800 + 200, y = Math.random() * 600 + 100) {
            const group = new Konva.Group({ x, y, draggable: true });

            const bg = new Konva.Rect({
                width: 240,
                height: 240,
                fill: 'rgba(50, 50, 80, 0.8)',
                stroke: '#8a8aff',
                strokeWidth: 2,
                cornerRadius: 16,
                shadowBlur: 20,
                shadowColor: 'rgba(138, 138, 255, 0.4)'
            });
            group.add(bg);

            let display;
            if (type === 'text') {
                display = new Konva.Text({
                    text: content.substring(0, 180) + '...',
                    width: 220,
                    padding: 16,
                    fontSize: 14,
                    fill: '#e0e0e0',
                    align: 'left'
                });
            } else {
                display = new Konva.Image({ width: 240, height: 240, cornerRadius: 16 });
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => { display.image(img); layer.draw(); };
                img.onerror = () => { img.src = 'https://via.placeholder.com/240x240/333355/ffffff?text=Loading...'; };
                img.src = content || 'https://via.placeholder.com/240x240/333355/ffffff?text=Generating';
            }
            group.add(display);

            group.on('click tap', () => {
                selectedNode = group;
                document.getElementById('node-prompt').value = content;
                if (type !== 'text') {
                    document.getElementById('preview').innerHTML =
                        type === 'video'
                            ? `<video src="${content}" controls autoplay loop muted style="max-height:300px;"></video>`
                            : `<img src="${content}">`;
                }
            });

            group.on('dragend', () => layer.draw());

            layer.add(group);
            nodes.push({ group, type, content });
            layer.draw();
        }

        // API è°ƒç”¨æ ¸å¿ƒï¼ˆä¿æŒä¸å˜ï¼Œä»…ä¼˜åŒ–æç¤ºï¼‰
        async function callAI(type, prompt) {
            // ï¼ˆåŒå‰ä¸€ä¸ªç‰ˆæœ¬çš„ callAI å®ç°ï¼Œä¿æŒå®Œæ•´é€»è¾‘ï¼‰
            // ä¸ºèŠ‚çœç¯‡å¹…è¿™é‡Œçœç•¥ï¼Œä½†è¯·ç›´æ¥å¤åˆ¶å‰ä¸€ç‰ˆçš„ callAI å‡½æ•°å®Œæ•´ä»£ç åˆ°è¿™é‡Œ
            const cfg = config[type];
            const key = document.getElementById('api-key').value || config.key;
            const key2 = document.getElementById('api-key2').value || config.key2;
            if (!key && !key2) return alert('è¯·å…ˆåœ¨é…ç½®é¢æ¿è¾“å…¥ API Key');

            let endpoint = document.getElementById('custom-endpoint').value || cfg.endpoint;
            let body, headers = { 'Content-Type': 'application/json' };

            if (cfg.provider.includes('kimi') || cfg.provider === 'openai' || cfg.provider === 'grok' || cfg.provider === 'qwen') {
                headers['Authorization'] = `Bearer ${key}`;
                body = { model: cfg.model, messages: [{ role: 'user', content: prompt }] };
            } else if (cfg.provider === 'nanobanana') {
                endpoint = `https://generativelanguage.googleapis.com/v1/models/${cfg.model}:generateContent?key=${key}`;
                body = { contents: [{ parts: [{ text: prompt }] }] };
            } else if (cfg.provider.includes('kling')) {
                headers['Authorization'] = `Bearer ${key}`;
                body = { model: cfg.model, prompt, duration: 10 };
            } else if (cfg.provider === 'vidu') {
                body = { model: 'vidu-q2', prompt };
            } else if (cfg.provider === 'veo') {
                endpoint = `https://us-central1-aiplatform.googleapis.com/v1/projects/YOUR_PROJECT/locations/us-central1/publishers/google/models/veo-3.1:predict`;
                headers['Authorization'] = `Bearer ${key2}`;
                body = { instances: [{ prompt }] };
            }

            try {
                const res = await fetch(endpoint, { method: 'POST', headers, body: JSON.stringify(body) });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (type === 'text') {
                    return data.choices?.[0]?.message?.content || data.candidates?.[0]?.content?.parts[0]?.text || data.text;
                }
                if (type === 'image') {
                    return data.data?.[0]?.url || data.candidates?.[0]?.content?.parts[0]?.inlineData?.url || data.images?.[0];
                }
                if (type === 'video') {
                    return data.video_url || data.output?.[0] || data.media?.[0];
                }
            } catch (e) {
                console.error(e);
                alert('API è°ƒç”¨å¤±è´¥ï¼š' + e.message + '\nè¯·æ£€æŸ¥ Key / Endpoint / é…é¢');
            }
        }

        // å…¶ä»–å‡½æ•°ï¼ˆsplitScriptã€batchGenerateã€regenerateSelectedã€saveConfig ç­‰ï¼‰ä¿æŒå‰ä¸€ç‰ˆé€»è¾‘ä¸å˜

        async function splitScript() {
            const file = document.getElementById('scriptUpload').files[0];
            if (!file) return alert('è¯·å…ˆä¸Šä¼ å‰§æœ¬æ–‡ä»¶');
            const text = await file.text();
            const enhancedPrompt = `è¯·ä¸“ä¸šæ‹†åˆ†ä»¥ä¸‹æ¼«å‰§å‰§æœ¬ä¸º10-15ä¸ªåœºæ™¯ï¼Œæ¯ä¸ªåœºæ™¯è¾“å‡ºJSONæ ¼å¼ï¼ŒåŒ…æ‹¬ï¼š
- description: åœºæ™¯æè¿°
- dialogue: å¯¹ç™½
- image_prompt: è¯¦ç»†æ¼«ç”»é£æ ¼å›¾åƒPrompt
- video_prompt: åŠ¨æ€è§†é¢‘Prompt
å‰§æœ¬ï¼š${text}`;
            const result = await callAI('text', enhancedPrompt);
            if (result) {
                try {
                    const scenes = JSON.parse(result);
                    scenes.forEach((s, i) => addNode('text', JSON.stringify(s), 200 + i * 260, 150));
                } catch {
                    const scenes = result.split('\n\n');
                    scenes.forEach((s, i) => addNode('text', s, 200 + i * 260, 150));
                }
            }
        }

        async function batchGenerate(type) {
            const textNodes = nodes.filter(n => n.type === 'text');
            if (textNodes.length === 0) return alert('è¯·å…ˆæ‹†åˆ†å‰§æœ¬');
            let progress = 0;
            document.getElementById('progress-bar').style.width = '0%';

            for (const node of textNodes) {
                const enhanced = node.content + `\nè¯·ç”Ÿæˆé«˜è´¨é‡${type === 'image' ? 'æ¼«ç”»é£æ ¼å›¾åƒ' : 'åŠ¨æ€è§†é¢‘'}ï¼Œè§’è‰²ä¸€è‡´ï¼Œé«˜ç»†èŠ‚`;
                const url = await callAI(type, enhanced);
                if (url) {
                    addNode(type, url, node.group.x() + 280, node.group.y());
                }
                progress += 100 / textNodes.length;
                document.getElementById('progress-bar').style.width = progress + '%';
            }
        }

        async function regenerateSelected(type) {
            if (!selectedNode) return alert('è¯·å…ˆç‚¹å‡»é€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹');
            const prompt = document.getElementById('node-prompt').value;
            if (!prompt) return alert('è¯·å¡«å†™ Prompt');
            const url = await callAI(type, prompt);
            if (url) {
                addNode(type, url, selectedNode.x() + 280, selectedNode.y());
            }
        }

        function toggleConfig() {
            const panel = document.getElementById('config-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function saveConfig() {
            config.key = document.getElementById('api-key').value;
            config.key2 = document.getElementById('api-key2').value;

            const textProv = document.getElementById('text-provider').value;
            if (textProv === 'kimi') {
                config.text.endpoint = 'https://api.moonshot.cn/v1/chat/completions';
                config.text.model = 'kimi-k2.5';
            }

            const imgProv = document.getElementById('image-provider').value;
            if (imgProv === 'nanobanana') {
                config.image.endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/';
                config.image.model = 'gemini-3-pro-image';
            }

            const vidProv = document.getElementById('video-provider').value;
            if (vidProv === 'kling26') {
                config.video.endpoint = 'https://api.klingai.com/v1/video/generate';
                config.video.model = 'kling-2.6';
            }

            localStorage.setItem('aiConfig', JSON.stringify(config));
            alert('é…ç½®å·²ä¿å­˜ï¼åˆ·æ–°é¡µé¢åç”Ÿæ•ˆ');
        }

        function loadConfig() {
            const saved = localStorage.getItem('aiConfig');
            if (saved) {
                config = JSON.parse(saved);
                // å¯è‡ªåŠ¨å¡«å……åˆ°è¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼‰
            }
        }

        function saveProject() {
            localStorage.setItem('aiProject', JSON.stringify(nodes.map(n => ({type: n.type, content: n.content, x: n.group.x(), y: n.group.y()}))));
            alert('é¡¹ç›®å·²ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°');
        }

        function loadProject() {
            const saved = localStorage.getItem('aiProject');
            if (!saved) return alert('æ²¡æœ‰ä¿å­˜çš„é¡¹ç›®');
            nodes = [];
            layer.destroyChildren();
            JSON.parse(saved).forEach(n => addNode(n.type, n.content, n.x, n.y));
            alert('é¡¹ç›®åŠ è½½æˆåŠŸ');
        }

        // ç¼©æ”¾
        stage.on('wheel', (e) => {
            e.evt.preventDefault();
            const scaleBy = 1.05;
            const oldScale = stage.scaleX();
            const newScale = e.evt.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;
            stage.scale({ x: newScale, y: newScale });
            layer.draw();
        });

        window.addEventListener('resize', () => {
            stage.width(window.innerWidth);
            stage.height(window.innerHeight);
        });
    </script>
</body>
</html>
