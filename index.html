<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¼«å‰§å·¥åŠ Flow Pro</title>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: #000000;
            color: #e0e0ff;
        }
        #container {
            width: 100vw;
            height: 100vh;
            background: #000000;
            position: relative;
        }
        #toolbar {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 24px;
            background: rgba(20, 20, 35, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 12px 24px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.8);
            z-index: 30;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid rgba(80, 80, 255, 0.2);
        }
        #toolbar button {
            background: rgba(50, 50, 100, 0.6);
            border: none;
            color: #ffffff;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 140px;
        }
        #toolbar button:hover {
            background: rgba(100, 100, 255, 0.8);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(100, 100, 255, 0.4);
        }
        #toolbar button.active {
            background: linear-gradient(135deg, #5e5eff, #8a73ff);
        }
        #left-sidebar {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(20, 20, 35, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 20px 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.8);
            z-index: 30;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 1px solid rgba(80, 80, 255, 0.2);
        }
        .sidebar-btn {
            width: 56px;
            height: 56px;
            background: rgba(50, 50, 100, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .sidebar-btn:hover {
            background: rgba(100, 100, 255, 0.8);
            transform: scale(1.1);
        }
        #properties {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(20, 20, 35, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.8);
            z-index: 30;
            width: 320px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(80, 80, 255, 0.2);
            display: none;
        }
        #properties h3 {
            margin: 0 0 20px 0;
            font-size: 1.5em;
            color: #a0a0ff;
        }
        label {
            display: block;
            margin: 16px 0 8px;
            font-size: 14px;
            color: #b0b0ff;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 14px;
            border: 1px solid rgba(100, 100, 255, 0.4);
            background: rgba(40, 40, 80, 0.6);
            color: #e0e0e0;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8a8aff;
            box-shadow: 0 0 16px rgba(138, 138, 255, 0.3);
        }
        #progress {
            background: rgba(40, 40, 80, 0.6);
            height: 12px;
            border-radius: 6px;
            margin-top: 20px;
            overflow: hidden;
        }
        #progress-bar {
            background: linear-gradient(90deg, #5e5eff, #a0ff8a);
            height: 100%;
            width: 0%;
            transition: width 0.6s ease;
        }
        .node {
            width: 260px;
            height: 160px;
            background: rgba(40, 40, 80, 0.9);
            border-radius: 24px;
            border: 2px solid #5e5eff;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            padding: 20px;
            color: white;
            font-weight: 600;
            text-align: center;
            position: relative;
        }
        .node-title {
            font-size: 18px;
            margin-bottom: 12px;
        }
        .node-status {
            font-size: 14px;
            color: #a0ffa0;
            margin-top: 20px;
        }
        .port-in, .port-out {
            width: 20px;
            height: 20px;
            background: #8a8aff;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        .port-in { left: -10px; }
        .port-out { right: -10px; }
        #context-menu {
            position: absolute;
            background: rgba(30, 30, 50, 0.95);
            backdrop-filter: blur(16px);
            border-radius: 16px;
            padding: 12px 0;
            box-shadow: 0 12px 40px rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }
        .menu-item {
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
        }
        .menu-item:hover {
            background: rgba(100, 100, 255, 0.4);
        }
    </style>
</head>
<body>
    <div id="left-sidebar">
        <div class="sidebar-btn" title="æ·»åŠ èŠ‚ç‚¹">â•</div>
        <div class="sidebar-btn" title="æ–‡å­—">T</div>
        <div class="sidebar-btn" title="æŒ‡é’ˆ">â˜œ</div>
        <div class="sidebar-btn" title="å›¾ç‰‡">ğŸ–¼ï¸</div>
        <div class="sidebar-btn" title="è§†é¢‘">ğŸ¬</div>
    </div>

    <div id="toolbar">
        <button onclick="runWorkflow()">â–¶ï¸ ä¸€é”®è¿è¡Œå·¥ä½œæµ</button>
        <button onclick="autoLayout()">ğŸ“ è‡ªåŠ¨å¸ƒå±€</button>
        <button onclick="saveProject()">ğŸ’¾ ä¿å­˜</button>
        <button onclick="loadProject()">ğŸ“‚ åŠ è½½</button>
        <button onclick="toggleGlobalConfig()">âš™ï¸ å…¨å±€é…ç½®</button>
        <div id="progress"><div id="progress-bar"></div></div>
    </div>

    <div id="properties">
        <h3>èŠ‚ç‚¹é…ç½®</h3>
        <div id="prop-content">å³é”®ç”»å¸ƒæ·»åŠ èŠ‚ç‚¹ï¼Œæˆ–ç‚¹å‡»èŠ‚ç‚¹é…ç½®</div>
    </div>

    <div id="context-menu">
        <div class="menu-item" data-type="script">ğŸ“„ å‰§æœ¬è¾“å…¥</div>
        <div class="menu-item" data-type="split">âœ‚ï¸ å‰§æœ¬æ‹†åˆ†ï¼ˆåˆ†é•œå¤´+å®šå¸§æç¤ºï¼‰</div>
        <div class="menu-item" data-type="image">ğŸ–¼ï¸ ç”Ÿå›¾èŠ‚ç‚¹</div>
        <div class="menu-item" data-type="video">ğŸ¬ ç”Ÿè§†é¢‘èŠ‚ç‚¹</div>
        <div class="menu-item" data-type="audio">ğŸ”Š é…éŸ³èŠ‚ç‚¹</div>
        <div class="menu-item" data-type="export">ğŸ“¤ å¯¼å‡ºçŸ­å‰§</div>
    </div>

    <div id="container"></div>

    <script>
        const stage = new Konva.Stage({ container: 'container', width: window.innerWidth, height: window.innerHeight, draggable: true });
        const layer = new Konva.Layer();
        const connectionsLayer = new Konva.Layer();
        stage.add(connectionsLayer);
        stage.add(layer);

        let nodes = [];
        let connections = [];
        let selectedNode = null;
        let connecting = null;
        let tempLine = null;

        // å³é”®èœå•
        const contextMenu = document.getElementById('context-menu');
        stage.on('contextmenu', (e) => {
            e.evt.preventDefault();
            const pointer = stage.getPointerPosition();
            contextMenu.style.display = 'block';
            contextMenu.style.left = pointer.x + 'px';
            contextMenu.style.top = pointer.y + 'px';
        });

        document.querySelectorAll('.menu-item').forEach(item => {
            item.onclick = () => {
                const pos = stage.getPointerPosition();
                createNode(item.dataset.type, pos.x - 130, pos.y - 80);
                contextMenu.style.display = 'none';
            };
        });

        document.addEventListener('click', () => {
            contextMenu.style.display = 'none';
        });

        // åˆ›å»ºèŠ‚ç‚¹
        function createNode(type, x = 400, y = 300) {
            const group = new Konva.Group({ x, y, draggable: true });

            const rect = new Konva.Rect({
                width: 260,
                height: 160,
                fill: 'rgba(40,40,80,0.9)',
                cornerRadius: 24,
                stroke: '#5e5eff',
                strokeWidth: 3,
                shadowBlur: 30,
                shadowColor: 'rgba(94,94,255,0.5)'
            });
            group.add(rect);

            const title = new Konva.Text({
                text: {
                    script: 'å‰§æœ¬è¾“å…¥', split: 'å‰§æœ¬æ‹†åˆ†', image: 'ç”Ÿå›¾', video: 'ç”Ÿè§†é¢‘', audio: 'é…éŸ³', export: 'å¯¼å‡ºçŸ­å‰§'
                }[type],
                x: 20, y: 30, fontSize: 20, fill: '#ffffff', fontStyle: 'bold'
            });
            group.add(title);

            const status = new Konva.Text({ x: 20, y: 100, fontSize: 15, fill: '#a0ffa0', text: 'å°±ç»ª' });
            group.add(status);

            const inPort = new Konva.Circle({ radius: 10, fill: '#8a8aff', className: 'port-in' });
            const outPort = new Konva.Circle({ radius: 10, fill: '#8a8aff', className: 'port-out' });
            group.add(inPort, outPort);

            inPort.on('mousedown', () => startConnection(group, 'in'));
            outPort.on('mousedown', () => startConnection(group, 'out'));

            group.on('dragmove', updateConnections);
            group.on('click tap', () => showProperties(group));

            group.customConfig = {
                provider: type === 'split' ? 'kimi' : type === 'image' ? 'nanobanana' : type === 'video' ? 'kling26' : type === 'audio' ? 'elevenlabs' : '',
                key: '',
                params: {} // ç‰¹å®šå‚æ•°ï¼Œå¦‚æ¯”ä¾‹ã€æ—¶é•¿ã€å‚è€ƒç­‰
            };

            group.data = { type, statusText: status, content: '' };

            layer.add(group);
            nodes.push(group);
            layer.draw();
            connectionsLayer.draw();
        }

        // å±æ€§é¢æ¿ï¼ˆé«˜åº¦å®šåˆ¶åŒ–ï¼‰
        function showProperties(node) {
            selectedNode = node;
            const type = node.data.type;
            const cfg = node.customConfig;

            let html = `<label>èŠ‚ç‚¹ï¼š${titleMap[type]}</label>`;

            if (type === 'split') {
                html += `
                <label>æ¨¡å‹</label>
                <select id="provider">
                    <option value="deepseek" ${cfg.provider === 'deepseek' ? 'selected' : ''}>DeepSeek æœ€æ–°</option>
                    <option value="kimi" ${cfg.provider === 'kimi' ? 'selected' : ''}>Kimi 2.5</option>
                    <option value="gemini" ${cfg.provider === 'gemini' ? 'selected' : ''}>Gemini 3 Pro</option>
                    <option value="grok" ${cfg.provider === 'grok' ? 'selected' : ''}>Grok æœ€æ–°</option>
                    <option value="gpt" ${cfg.provider === 'gpt' ? 'selected' : ''}>GPT æœ€æ–°</option>
                </select>
                <label>API Key / è´¦æˆ·</label>
                <input type="password" id="node-key" value="${cfg.key}">
                <label>é¢å¤–æç¤ºï¼ˆåˆ†é•œå¤´æ•°é‡ç­‰ï¼‰</label>
                <textarea id="extra-prompt">${cfg.params.extra || ''}</textarea>
                `;
            } else if (type === 'image') {
                html += `
                <label>æ¨¡å‹</label>
                <select id="provider">
                    <option value="nanobanana" ${cfg.provider === 'nanobanana' ? 'selected' : ''}>NanoBananaPro</option>
                    <option value="midjourney" ${cfg.provider === 'midjourney' ? 'selected' : ''}>Midjourney V7 / Niji V7</option>
                    <option value="seedream" ${cfg.provider === 'seedream' ? 'selected' : ''}>Seedream 4.5</option>
                    <option value="grok-image" ${cfg.provider === 'grok-image' ? 'selected' : ''}>Grok æœ€æ–°ç”Ÿå›¾</option>
                </select>
                <label>API Key / Discordè´¦æˆ·</label>
                <input type="password" id="node-key" value="${cfg.key}">
                <label>æ¯”ä¾‹</label>
                <select id="aspect">
                    <option>1:1</option>
                    <option>16:9</option>
                    <option>9:16</option>
                    <option>è‡ªå®šä¹‰</option>
                </select>
                <label>è‡ªå®šä¹‰æ¯”ä¾‹ (width:height)</label>
                <input id="custom-aspect" placeholder="1024:1024">
                <label>æ¸…æ™°åº¦</label>
                <select id="resolution">
                    <option>1K</option>
                    <option>2K</option>
                    <option>4K</option>
                </select>
                <label>ç”Ÿæˆæ•°é‡</label>
                <select id="count">
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                </select>
                `;
            } else if (type === 'video') {
                html += `
                <label>æ¨¡å‹</label>
                <select id="provider">
                    <option value="kling26" ${cfg.provider === 'kling26' ? 'selected' : ''}>å¯çµ 2.6 (10s, éŸ³ç”»åŒæ­¥)</option>
                    <option value="klingo1" ${cfg.provider === 'klingo1' ? 'selected' : ''}>å¯çµ O1 (è‡ªç„¶ç¼–è¾‘, å¤šæ¨¡æ€å‚è€ƒ)</option>
                    <option value="wan26" ${cfg.provider === 'wan26' ? 'selected' : ''}>Wan 2.6 (15s, å¤šæœºä½)</option>
                    <option value="jimeng" ${cfg.provider === 'jimeng' ? 'selected' : ''}>å³æ¢¦ 3.5 Pro (12s, å¤šæœºä½)</option>
                    <option value="vidu" ${cfg.provider === 'vidu' ? 'selected' : ''}>Vidu Q2 (8s, å¤šå›¾å‚è€ƒ)</option>
                    <option value="grok-video" ${cfg.provider === 'grok-video' ? 'selected' : ''}>Grok æœ€æ–°è§†é¢‘</option>
                    <option value="veo" ${cfg.provider === 'veo' ? 'selected' : ''}>Veo 3.1</option>
                    <option value="sora" ${cfg.provider === 'sora' ? 'selected' : ''}>Sora 2</option>
                </select>
                <label>API Key</label>
                <input type="password" id="node-key" value="${cfg.key}">
                <label>æ¨¡å¼</label>
                <select id="mode">
                    <option>æ–‡ç”Ÿè§†é¢‘</option>
                    <option>å›¾ç”Ÿè§†é¢‘</option>
                    <option>é¦–å°¾å¸§</option>
                    <option>å¤šå¸§å‚è€ƒ</option>
                </select>
                <label>æ—¶é•¿ (ç§’)</label>
                <input type="number" id="duration" value="10">
                <label>å¯ç”¨éŸ³ç”»åŒæ­¥</label>
                <input type="checkbox" id="lip-sync" ${cfg.params.lipSync ? 'checked' : ''}>
                <label>å¤šæœºä½é•œå¤´</label>
                <input type="checkbox" id="multi-camera" ${cfg.params.multiCamera ? 'checked' : ''}>
                `;
            } else if (type === 'audio') {
                html += `
                <label>æ¨¡å‹</label>
                <select id="provider">
                    <option value="minimax">Minimax</option>
                    <option value="elevenlabs">ElevenLabs</option>
                    <option value="ttsmaker">TTSMaker</option>
                </select>
                <label>API Key</label>
                <input type="password" id="node-key" value="${cfg.key}">
                `;
            }

            html += `<button onclick="saveNodeConfig()">ä¿å­˜é…ç½®</button>
                     <button onclick="runSingleNode()">è¿è¡Œæ­¤èŠ‚ç‚¹</button>`;

            document.getElementById('prop-content').innerHTML = html;
            document.getElementById('properties').style.display = 'block';
        }

        // ä¿å­˜èŠ‚ç‚¹é…ç½®ï¼ˆç®€åŒ–ï¼‰
        function saveNodeConfig() {
            if (!selectedNode) return;
            const cfg = selectedNode.customConfig;
            cfg.provider = document.getElementById('provider')?.value || cfg.provider;
            cfg.key = document.getElementById('node-key')?.value || '';
            // ä¿å­˜å…¶ä»–å‚æ•°åˆ° cfg.params
            alert('èŠ‚ç‚¹é…ç½®å·²ä¿å­˜');
        }

        // è¿çº¿é€»è¾‘ï¼ˆå®Œå–„ï¼‰
        function startConnection(node, dir) {
            connecting = { node, dir };
            stage.on('mousemove', drawTempLine);
            stage.on('mouseup', endConnection);
        }

        function drawTempLine(e) {
            if (!tempLine) {
                tempLine = new Konva.Arrow({ stroke: '#8a8aff', strokeWidth: 5, pointerLength: 15, pointerWidth: 15 });
                connectionsLayer.add(tempLine);
            }
            const pos = stage.getPointerPosition();
            const start = connecting.node.absolutePosition();
            const sx = connecting.dir === 'out' ? start.x + 260 : start.x;
            tempLine.points([sx, start.y + 80, pos.x, pos.y]);
            connectionsLayer.draw();
        }

        function endConnection() {
            if (tempLine) tempLine.destroy();
            stage.off('mousemove mouseup');
            connecting = null;
        }

        // å…¶ä»–å‡½æ•°å ä½
        function runWorkflow() { alert('å·¥ä½œæµè¿è¡Œä¸­...æ•°æ®å°†æ²¿è¿çº¿è‡ªåŠ¨ä¼ é€’'); }
        function autoLayout() { /* è‡ªåŠ¨æ’åˆ—èŠ‚ç‚¹ */ }
        function saveProject() { alert('ä¿å­˜é¡¹ç›®'); }
        function loadProject() { alert('åŠ è½½é¡¹ç›®'); }

        // ç¼©æ”¾
        stage.on('wheel', (e) => {
            e.evt.preventDefault();
            const scaleBy = 1.08;
            const oldScale = stage.scaleX();
            const newScale = e.evt.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;
            stage.scale({ x: newScale, y: newScale });
            layer.draw();
            connectionsLayer.draw();
        });

        window.addEventListener('resize', () => {
            stage.width(window.innerWidth);
            stage.height(window.innerHeight);
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¼«å‰§å·¥åŠ Flow</title>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: #0f0f1a;
            color: #e0e0ff;
        }
        #container {
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1a 100%);
        }
        #toolbar {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(30, 30, 50, 0.85);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            z-index: 20;
            width: 280px;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }
        #node-palette {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(30, 30, 50, 0.85);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            z-index: 20;
            width: 280px;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }
        #properties {
            position: absolute;
            right: 20px;
            bottom: 20px;
            background: rgba(30, 30, 50, 0.85);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            z-index: 20;
            width: 280px;
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }
        h3 {
            margin: 0 0 16px 0;
            font-size: 1.4em;
            color: #a0a0ff;
        }
        button, .node-template {
            background: linear-gradient(135deg, #5e5eff, #8a73ff);
            border: none;
            color: white;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 14px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            text-align: left;
        }
        button:hover, .node-template:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(138, 138, 255, 0.5);
        }
        .node-template {
            background: linear-gradient(135deg, #3a3a6e, #5e5eff);
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 12px;
            border: 1px solid rgba(100, 100, 255, 0.4);
            background: rgba(50, 50, 80, 0.6);
            color: #e0e0e0;
            font-size: 14px;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #8a8aff;
            box-shadow: 0 0 16px rgba(138, 138, 255, 0.4);
        }
        label {
            font-size: 13px;
            color: #b0b0ff;
            margin-top: 8px;
            display: block;
        }
        #progress {
            background: rgba(50, 50, 80, 0.6);
            height: 10px;
            border-radius: 5px;
            margin-top: 12px;
            overflow: hidden;
        }
        #progress-bar {
            background: linear-gradient(90deg, #5e5eff, #a0ff8a);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }
        .port-in { width: 16px; height: 16px; background: #8a8aff; border-radius: 50%; position: absolute; left: -8px; top: 50%; transform: translateY(-50%); cursor: crosshair; }
        .port-out { width: 16px; height: 16px; background: #8a8aff; border-radius: 50%; position: absolute; right: -8px; top: 50%; transform: translateY(-50%); cursor: crosshair; }
    </style>
</head>
<body>
    <div id="toolbar">
        <h3>AI æ¼«å‰§å·¥åŠ Flow</h3>
        <input type="file" id="scriptUpload" accept=".txt,.docx">
        <button onclick="toggleGlobalConfig()">âš™ï¸ å…¨å±€é»˜è®¤ API é…ç½®</button>
        <button onclick="autoLayout()">ğŸ“ è‡ªåŠ¨å¸ƒå±€</button>
        <button onclick="runWorkflow()">â–¶ï¸ ä¸€é”®è¿è¡Œå·¥ä½œæµ</button>
        <button onclick="saveProject()">ğŸ’¾ ä¿å­˜é¡¹ç›®</button>
        <button onclick="loadProject()">ğŸ“‚ åŠ è½½é¡¹ç›®</button>
        <div id="progress"><div id="progress-bar"></div></div>

        <div id="global-config" style="display:none;margin-top:16px;">
            <h3>å…¨å±€é»˜è®¤é…ç½®ï¼ˆèŠ‚ç‚¹å¯å•ç‹¬è¦†ç›–ï¼‰</h3>
            <label>é»˜è®¤æ–‡æœ¬æ¨¡å‹</label>
            <select id="global-text-provider">
                <option value="kimi" selected>Kimi K2.5</option>
                <option value="openai">OpenAI GPT-4o</option>
                <option value="grok">xAI Grok</option>
                <option value="qwen">é˜¿é‡Œ Qwen</option>
            </select>
            <label>é»˜è®¤å›¾åƒæ¨¡å‹</label>
            <select id="global-image-provider">
                <option value="nanobanana" selected>Nano Banana Pro</option>
                <option value="dalle">DALLÂ·E 3</option>
                <option value="flux">Stability Flux</option>
            </select>
            <label>é»˜è®¤è§†é¢‘æ¨¡å‹</label>
            <select id="global-video-provider">
                <option value="kling26" selected>Kling 2.6</option>
                <option value="vidu">Vidu Q2</option>
                <option value="veo">Veo 3.1</option>
                <option value="runway">Runway Gen-4</option>
            </select>
            <label>å…¨å±€é»˜è®¤ Keyï¼ˆå¯é€‰ï¼‰</label>
            <input type="password" id="global-api-key" placeholder="å¤šæ•°æ¨¡å‹å…±ç”¨">
            <button onclick="saveGlobalConfig()" style="margin-top:12px;">ä¿å­˜å…¨å±€é…ç½®</button>
        </div>
    </div>

    <div id="node-palette">
        <h3>èŠ‚ç‚¹åº“ï¼ˆæ‹–æ‹½åˆ°ç”»å¸ƒï¼‰</h3>
        <div class="node-template" data-type="script">ğŸ“„ å‰§æœ¬è¾“å…¥</div>
        <div class="node-template" data-type="split">âœ‚ï¸ å‰§æœ¬æ‹†åˆ†</div>
        <div class="node-template" data-type="image">ğŸ–¼ï¸ ç”Ÿå›¾èŠ‚ç‚¹</div>
        <div class="node-template" data-type="video">ğŸ¬ ç”Ÿè§†é¢‘èŠ‚ç‚¹</div>
        <div class="node-template" data-type="audio">ğŸ”Š ç”ŸéŸ³é¢‘èŠ‚ç‚¹</div>
        <div class="node-template" data-type="export">ğŸ“¤ å¯¼å‡ºè§†é¢‘</div>
    </div>

    <div id="properties">
        <h3>èŠ‚ç‚¹å±æ€§ï¼ˆç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹ï¼‰</h3>
        <div id="prop-content">ç‚¹å‡»ç”»å¸ƒä¸Šçš„èŠ‚ç‚¹ä»¥ç¼–è¾‘å…¶ç‹¬ç«‹é…ç½®å’Œ Prompt</div>
    </div>

    <div id="container"></div>

    <script>
        const stage = new Konva.Stage({ container: 'container', width: window.innerWidth, height: window.innerHeight, draggable: true });
        const layer = new Konva.Layer();
        const connectionsLayer = new Konva.Layer();
        stage.add(connectionsLayer);
        stage.add(layer);

        let nodes = [];
        let connections = [];
        let selectedNode = null;
        let connecting = null;
        let tempLine = null;

        // å…¨å±€é»˜è®¤é…ç½®
        let globalConfig = {
            text: 'kimi',
            image: 'nanobanana',
            video: 'kling26',
            key: ''
        };
        loadGlobalConfig();

        // åˆ›å»ºèŠ‚ç‚¹
        function createNode(type, x = 300, y = 200) {
            const group = new Konva.Group({ x, y, draggable: true });

            const rect = new Konva.Rect({
                width: 240,
                height: 140,
                fill: 'rgba(50,50,90,0.9)',
                stroke: '#8a8aff',
                strokeWidth: 3,
                cornerRadius: 20,
                shadowBlur: 20,
                shadowColor: 'rgba(138,138,255,0.5)'
            });
            group.add(rect);

            const title = new Konva.Text({
                text: {
                    script: 'å‰§æœ¬è¾“å…¥', split: 'å‰§æœ¬æ‹†åˆ†', image: 'ç”Ÿå›¾', video: 'ç”Ÿè§†é¢‘', audio: 'ç”ŸéŸ³é¢‘', export: 'å¯¼å‡º'
                }[type],
                x: 20, y: 20, fontSize: 18, fill: '#ffffff', fontStyle: 'bold'
            });
            group.add(title);

            const status = new Konva.Text({ x: 20, y: 60, fontSize: 14, fill: '#a0ffa0', text: 'å°±ç»ª' });
            group.add(status);

            const inPort = new Konva.Circle({ className: 'port-in', radius: 10, fill: '#8a8aff' });
            const outPort = new Konva.Circle({ className: 'port-out', radius: 10, fill: '#8a8aff' });
            group.add(inPort, outPort);

            inPort.on('mousedown', () => startConnection(group, 'in'));
            outPort.on('mousedown', () => startConnection(group, 'out'));

            group.on('dragmove', updateConnections);
            group.on('click tap', () => showProperties(group));

            // èŠ‚ç‚¹ä¸“å±é…ç½®ï¼ˆé»˜è®¤ç»§æ‰¿å…¨å±€ï¼Œå¯è¦†ç›–ï¼‰
            group.customConfig = {
                useGlobal: true,
                provider: type === 'split' ? globalConfig.text : type === 'image' ? globalConfig.image : type === 'video' ? globalConfig.video : '',
                key: '',
                prompt: ''
            };

            group.data = { type, statusText: status, content: '' };

            layer.add(group);
            nodes.push(group);
            layer.draw();
            connectionsLayer.draw();
        }

        // æ˜¾ç¤ºèŠ‚ç‚¹ç‹¬ç«‹å±æ€§é¢æ¿
        function showProperties(node) {
            selectedNode = node;
            const cfg = node.customConfig;
            const type = node.data.type;

            let html = `<label>èŠ‚ç‚¹ç±»å‹ï¼š${{
                script: 'å‰§æœ¬è¾“å…¥', split: 'å‰§æœ¬æ‹†åˆ†', image: 'ç”Ÿå›¾', video: 'ç”Ÿè§†é¢‘'
            }[type]}</label>`;

            if (type === 'split' || type === 'image' || type === 'video') {
                html += `
                <label><input type="checkbox" id="use-global" ${cfg.useGlobal ? 'checked' : ''}> ä½¿ç”¨å…¨å±€é»˜è®¤é…ç½®</label>
                <label>æ¨¡å‹é€‰æ‹©ï¼ˆç‹¬ç«‹è¦†ç›–ï¼‰</label>
                <select id="node-provider">
                    ${type === 'split' ? `
                        <option value="kimi" ${cfg.provider === 'kimi' ? 'selected' : ''}>Kimi K2.5</option>
                        <option value="openai" ${cfg.provider === 'openai' ? 'selected' : ''}>OpenAI GPT-4o</option>
                    ` : type === 'image' ? `
                        <option value="nanobanana" ${cfg.provider === 'nanobanana' ? 'selected' : ''}>Nano Banana Pro</option>
                        <option value="dalle" ${cfg.provider === 'dalle' ? 'selected' : ''}>DALLÂ·E 3</option>
                        <option value="flux" ${cfg.provider === 'flux' ? 'selected' : ''}>Flux</option>
                    ` : `
                        <option value="kling26" ${cfg.provider === 'kling26' ? 'selected' : ''}>Kling 2.6</option>
                        <option value="veo" ${cfg.provider === 'veo' ? 'selected' : ''}>Veo 3.1</option>
                        <option value="vidu" ${cfg.provider === 'vidu' ? 'selected' : ''}>Vidu Q2</option>
                    `}
                </select>
                <label>ç‹¬ç«‹ API Keyï¼ˆå¯é€‰ï¼‰</label>
                <input type="password" id="node-key" value="${cfg.key}" placeholder="ç•™ç©ºä½¿ç”¨å…¨å±€">
                <label>è‡ªå®šä¹‰ Promptï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="node-prompt" rows="4">${cfg.prompt}</textarea>
                <button onclick="saveNodeConfig()">ä¿å­˜èŠ‚ç‚¹é…ç½®</button>
                <button onclick="runSingleNode()">â–¶ï¸ å•ç‹¬è¿è¡Œæ­¤èŠ‚ç‚¹</button>
                `;
            }

            document.getElementById('prop-content').innerHTML = html;
            document.getElementById('properties').style.display = 'block';
        }

        function saveNodeConfig() {
            if (!selectedNode) return;
            const cfg = selectedNode.customConfig;
            cfg.useGlobal = document.getElementById('use-global')?.checked || false;
            cfg.provider = document.getElementById('node-provider')?.value || cfg.provider;
            cfg.key = document.getElementById('node-key')?.value || '';
            cfg.prompt = document.getElementById('node-prompt')?.value || '';
            alert('èŠ‚ç‚¹é…ç½®å·²ä¿å­˜');
        }

        // è¿çº¿é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼Œå®Œæ•´ç‰ˆå¯æ‰©å±•ï¼‰
        function startConnection(node, direction) {
            connecting = { node, direction };
            stage.on('mousemove', drawTempLine);
            stage.on('mouseup', () => {
                if (tempLine) tempLine.destroy();
                stage.off('mousemove mouseup');
                connecting = null;
            });
        }

        function drawTempLine(e) {
            if (!tempLine) {
                tempLine = new Konva.Arrow({ stroke: '#8a8aff', strokeWidth: 4, pointerLength: 10, pointerWidth: 10 });
                connectionsLayer.add(tempLine);
            }
            const pos = stage.getPointerPosition();
            const start = connecting.node.absolutePosition();
            const startX = connecting.direction === 'out' ? start.x + 240 : start.x;
            tempLine.points([startX, start.y + 70, pos.x, pos.y]);
            connectionsLayer.draw();
        }

        function updateConnections() {
            connectionsLayer.draw();
        }

        // èŠ‚ç‚¹åº“æ‹–æ‹½
        document.querySelectorAll('.node-template').forEach(el => {
            el.draggable = true;
            el.ondragend = (e) => {
                const pos = stage.getPointerPosition();
                if (pos) createNode(el.dataset.type, pos.x - 120, pos.y - 70);
            };
        });

        // å…¨å±€é…ç½®å‡½æ•°
        function toggleGlobalConfig() {
            const panel = document.getElementById('global-config');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function saveGlobalConfig() {
            globalConfig.text = document.getElementById('global-text-provider').value;
            globalConfig.image = document.getElementById('global-image-provider').value;
            globalConfig.video = document.getElementById('global-video-provider').value;
            globalConfig.key = document.getElementById('global-api-key').value;
            localStorage.setItem('globalAIConfig', JSON.stringify(globalConfig));
            alert('å…¨å±€é…ç½®å·²ä¿å­˜');
        }

        function loadGlobalConfig() {
            const saved = localStorage.getItem('globalAIConfig');
            if (saved) globalConfig = JSON.parse(saved);
        }

        // å…¶ä»–å‡½æ•°ï¼ˆautoLayoutã€runWorkflowã€saveProject ç­‰ï¼‰å¯åç»­æ‰©å±•
        function autoLayout() { alert('è‡ªåŠ¨å¸ƒå±€åŠŸèƒ½å¼€å‘ä¸­...'); }
        function runWorkflow() { alert('ä¸€é”®è¿è¡Œå·¥ä½œæµå¼€å‘ä¸­...'); }
        function saveProject() { alert('é¡¹ç›®ä¿å­˜å¼€å‘ä¸­...'); }
        function loadProject() { alert('é¡¹ç›®åŠ è½½å¼€å‘ä¸­...'); }

        // ç¼©æ”¾ä¸resize
        stage.on('wheel', (e) => {
            e.evt.preventDefault();
            const scaleBy = 1.05;
            const oldScale = stage.scaleX();
            const newScale = e.evt.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;
            stage.scale({ x: newScale, y: newScale });
            layer.draw(); connectionsLayer.draw();
        });

        window.addEventListener('resize', () => {
            stage.width(window.innerWidth);
            stage.height(window.innerHeight);
        });
    </script>
</body>
</html>
