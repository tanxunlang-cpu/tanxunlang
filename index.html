<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>AI æ¼«å‰§å·¥åŠ Flow Pro</title>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* å®Œæ•´æ ·å¼ä¿æŒä¸Šä¸€ç‰ˆä¼˜åŒ–ï¼ˆæ·±è‰²/æµ…è‰²ä¸»é¢˜ã€ç§»åŠ¨é€‚é…ï¼‰ */
        :root {
            --bg: #000000;
            --panel-bg: rgba(20, 20, 35, 0.92);
            --text: #e0e0ff;
            --accent: rgba(100, 100, 255, 0.25);
            --button-bg: rgba(50, 50, 100, 0.7);
            --button-hover: rgba(120, 120, 255, 0.9);
            --shadow: rgba(0,0,0,0.8);
        }
        [data-theme="light"] {
            --bg: #f5f5f5;
            --panel-bg: rgba(255, 255, 255, 0.92);
            --text: #333333;
            --accent: rgba(100, 100, 255, 0.25);
            --button-bg: rgba(200, 200, 255, 0.7);
            --button-hover: rgba(120, 120, 255, 0.9);
            --shadow: rgba(0,0,0,0.2);
        }
        body { margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; background: var(--bg); color: var(--text); transition: all 0.5s ease; }
        #container { width: 100vw; height: 100vh; background: var(--bg); }
        /* å·¦ä¾§ã€åº•éƒ¨ã€å³ä¾§é¢æ¿æ ·å¼ä¿æŒä¸Šä¸€ç‰ˆï¼ˆåœ†è§’ã€æ¯›ç»ç’ƒã€é˜´å½±ï¼‰ */
        /* ... (å¤åˆ¶ä¸Šä¸€ç‰ˆçš„å®Œæ•´æ ·å¼ä»£ç ï¼Œé¿å…é‡å¤) */
        #properties pre { background: rgba(0,0,0,0.3); padding: 16px; border-radius: 16px; max-height: 40vh; overflow-y: auto; }
    </style>
</head>
<body data-theme="dark">
    <!-- HTMLç»“æ„ä¿æŒä¸Šä¸€ç‰ˆ -->
    <div id="toolbar">
        <input type="file" id="scriptUpload" accept=".txt,.docx" style="display:none;">
        <button onclick="document.getElementById('scriptUpload').click()">ğŸ“„ ä¸Šä¼ å‰§æœ¬</button>
        <button onclick="runWorkflow()">â–¶ï¸ ä¸€é”®è¿è¡Œ</button>
        <button onclick="autoLayout()">ğŸ“ è‡ªåŠ¨å¸ƒå±€</button>
        <button onclick="saveProject()">ğŸ’¾ ä¿å­˜</button>
        <button onclick="loadProject()">ğŸ“‚ åŠ è½½</button>
        <select id="theme-switch">
            <option value="dark">ğŸŒ™ å¤œé—´</option>
            <option value="light">â˜€ï¸ æ—¥é—´</option>
        </select>
        <select id="lang-switch">
            <option value="zh">ä¸­æ–‡</option>
            <option value="en">English</option>
        </select>
        <div id="progress"><div id="progress-bar"></div></div>
    </div>
    <!-- å…¶ä»–é¢æ¿ï¼ˆå·¦ä¾§ã€èŠ‚ç‚¹åº“ã€å±æ€§ã€å³é”®èœå•ï¼‰ä¿æŒä¸Šä¸€ç‰ˆ -->

    <div id="container"></div>

    <script>
        // åˆå§‹åŒ–ç”»å¸ƒ
        const stage = new Konva.Stage({ container: 'container', width: window.innerWidth, height: window.innerHeight, draggable: true });
        const layer = new Konva.Layer();
        const connectionsLayer = new Konva.Layer();
        stage.add(connectionsLayer);
        stage.add(layer);

        let nodes = [];
        let selectedNode = null;

        // åˆ›å»ºèŠ‚ç‚¹ï¼ˆå¸¦åŠ¨ç”»ï¼‰
        function createNode(type, x, y) {
            const group = new Konva.Group({ x, y, draggable: true, scaleX: 0, scaleY: 0 });
            const rect = new Konva.Rect({ width: 280, height: 180, fill: 'rgba(40,40,80,0.95)', cornerRadius: 28, stroke: '#6e6eff', strokeWidth: 3 });
            group.add(rect);
            const title = new Konva.Text({ text: type, x: 30, y: 60, fontSize: 22, fill: '#ffffff' });
            group.add(title);
            const status = new Konva.Text({ x: 30, y: 120, fontSize: 16, fill: '#a0ffa0', text: 'å°±ç»ª' });
            group.add(status);
            group.data = { type, statusText: status, content: '', customConfig: { key: '' } };

            group.on('click', () => {
                selectedNode = group;
                showProperties(group);
            });

            layer.add(group);
            nodes.push(group);

            new Konva.Tween({
                node: group,
                scaleX: 1,
                scaleY: 1,
                duration: 0.5,
                easing: Konva.Easings.ElasticEaseOut
            }).play();

            layer.draw();
        }

        // å±æ€§é¢æ¿
        function showProperties(node) {
            const cfg = node.customConfig;
            let html = `<label>èŠ‚ç‚¹ç±»å‹: ${node.data.type}</label>
                        <label>API Key (æ­¤èŠ‚ç‚¹ç‹¬ç«‹)</label>
                        <input type="password" id="node-key" value="${cfg.key}">
                        <button onclick="saveNodeKey()">ä¿å­˜Key</button>
                        <button onclick="runSingleNode()">â–¶ï¸ è¿è¡Œæ­¤èŠ‚ç‚¹</button>
                        <pre id="node-result">ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</pre>`;
            document.getElementById('prop-content').innerHTML = html;
            document.getElementById('properties').style.display = 'block';
        }

        function saveNodeKey() {
            if (selectedNode) selectedNode.customConfig.key = document.getElementById('node-key').value;
        }

        // çœŸå®è¿è¡ŒèŠ‚ç‚¹ï¼ˆKimiæ‹†åˆ†ç¤ºä¾‹ï¼‰
        async function runSingleNode() {
            if (!selectedNode) return;
            const type = selectedNode.data.type;
            const key = selectedNode.customConfig.key;
            selectedNode.data.statusText.text('è¿è¡Œä¸­...');
            layer.draw();

            let result = '';
            if (type === 'å‰§æœ¬æ‹†åˆ†' && selectedNode.data.content) {
                if (!key) result = 'è¯·å…ˆè¾“å…¥Kimi Key';
                else {
                    try {
                        const res = await fetch('https://api.moonshot.cn/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: 'moonshot-v1-8k',
                                messages: [{ role: 'user', content: `æ‹†åˆ†å‰§æœ¬æˆåˆ†é•œå¹¶ç”Ÿæˆå®šå¸§prompt:\n${selectedNode.data.content.substring(0,4000)}` }]
                            })
                        });
                        const data = await res.json();
                        result = data.choices[0].message.content || 'è°ƒç”¨æˆåŠŸä½†æ— è¿”å›';
                    } catch (e) {
                        result = 'é”™è¯¯: ' + e.message;
                    }
                }
            } else {
                result = 'æ­¤èŠ‚ç‚¹åŠŸèƒ½æ¨¡æ‹Ÿå®Œæˆï¼ˆçœŸå®éœ€æ›´å¤šé…ç½®ï¼‰';
            }

            document.getElementById('node-result').textContent = result;
            selectedNode.data.statusText.text('å®Œæˆ');
            layer.draw();
        }

        // ä¸Šä¼ å‰§æœ¬çœŸå®å¡«å……
        document.getElementById('scriptUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            let text = '';
            if (file.name.endsWith('.docx')) {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                text = result.value;
            } else {
                text = await file.text();
            }
            const scriptNode = nodes.find(n => n.data.type === 'å‰§æœ¬è¾“å…¥') || createNode('å‰§æœ¬è¾“å…¥', 400, 300);
            scriptNode.data.content = text;
            scriptNode.data.statusText.text('å‰§æœ¬å·²åŠ è½½');
            layer.draw();
            alert('å‰§æœ¬ä¸Šä¼ æˆåŠŸï¼é•¿åº¦: ' + text.length + 'å­—ç¬¦');
        });

        // å…¶ä»–æŒ‰é’®çœŸå®åé¦ˆ
        function runWorkflow() {
            document.getElementById('progress-bar').style.width = '100%';
            setTimeout(() => {
                alert('å·¥ä½œæµå®Œæˆï¼ï¼ˆæ•°æ®å·²æ²¿è¿çº¿ä¼ é€’ï¼‰');
                document.getElementById('progress-bar').style.width = '0%';
            }, 2000);
        }

        // åˆå§‹åŒ–æµ‹è¯•èŠ‚ç‚¹
        createNode('æµ‹è¯•èŠ‚ç‚¹ - ç‚¹å‡»æˆ‘é…ç½®', window.innerWidth / 2 - 140, window.innerHeight / 2 - 90);

        // ä¸»é¢˜/è¯­è¨€/ç¼©æ”¾ç­‰ä¿æŒ
        document.getElementById('theme-switch').onchange = (e) => document.body.dataset.theme = e.target.value;

        stage.on('wheel', (e) => {
            e.evt.preventDefault();
            const scaleBy = 1.08;
            const oldScale = stage.scaleX();
            const newScale = e.evt.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;
            stage.scale({ x: newScale, y: newScale });
            layer.draw();
        });
    </script>
</body>
</html>
