<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Short Drama Workflow - Mac Style</title>
  <script src="https://unpkg.com/litegraph.js@0.7.12/build/litegraph.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/litegraph.js@0.7.12/styles/litegraph.css">
  <style>
    :root {
      --bg: #f5f5f7;
      --surface: rgba(255,255,255,0.75);
      --text: #1d1d1f;
      --border: rgba(0,0,0,0.08);
      --accent: #007aff;
      --node-bg: #ffffff;
      --node-title: #f0f0f0;
    }
    [data-theme="dark"] {
      --bg: #1c1c1e;
      --surface: rgba(30,30,32,0.85);
      --text: #f5f5f7;
      --border: rgba(255,255,255,0.12);
      --accent: #0a84ff;
      --node-bg: #2c2c2e;
      --node-title: #3a3a3c;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    header {
      background: var(--surface);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }
    h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
      letter-spacing: -0.5px;
    }
    .controls {
      display: flex;
      gap: 12px;
    }
    button, input, select {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 14px;
      background: var(--surface);
      color: var(--text);
      font-size: 0.95rem;
      cursor: pointer;
    }
    button.primary { background: var(--accent); color: white; border: none; }
    #canvas-container {
      flex: 1;
      position: relative;
    }
    #graph-canvas {
      width: 100%;
      height: 100%;
    }
    .config-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      width: 320px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      z-index: 5;
      display: none;
    }
    .config-panel.show { display: block; }
    label { display: block; margin: 12px 0 4px; font-size: 0.9rem; font-weight: 500; }
    input[type="text"], input[type="password"] {
      width: 100%;
      box-sizing: border-box;
    }
    .node-output {
      margin-top: 8px;
      padding: 8px;
      background: rgba(0,0,0,0.03);
      border-radius: 8px;
      font-size: 0.85rem;
      max-height: 120px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

<header>
  <h1>AI Short Drama Canvas</h1>
  <div class="controls">
    <button onclick="toggleTheme()">切换深色</button>
    <button onclick="toggleConfig()">API 配置</button>
    <button class="primary" onclick="runWorkflow()">执行工作流</button>
  </div>
</header>

<div id="canvas-container">
  <canvas id="graph-canvas"></canvas>
</div>

<div id="configPanel" class="config-panel">
  <h3>API 配置（保存到 localStorage）</h3>
  <label>OpenAI / Groq / Together API Key</label>
  <input id="apiKey" type="password" placeholder="sk-... 或 gsk_...">

  <label>图像/视频生成 Base URL (Replicate/Fal/Kling 等)</label>
  <input id="baseUrl" type="text" placeholder="https://api.replicate.com/v1 或 https://fal.run" value="https://api.openai.com/v1">

  <label>默认模型 (text-to-image/video)</label>
  <select id="model">
    <option value="gpt-4o">GPT-4o (脚本/分镜)</option>
    <option value="flux-pro">Flux.1 Pro (图像)</option>
    <option value="kling-1.5">Kling 1.5 / 2.0</option>
    <option value="veo-3">Veo 3</option>
    <option value="hailuo-02">Hailuo 02 / MiniMax</option>
    <option value="custom">自定义模型名</option>
  </select>

  <label>自定义模型名</label>
  <input id="customModel" type="text" placeholder="black-forest-labs/flux-pro 等">

  <button class="primary" style="margin-top:16px;width:100%;" onclick="saveConfig()">保存配置</button>
</div>

<script>
// ==================== LiteGraph 初始化 ====================
const graph = new LGraph();
const canvas = new LGraphCanvas("#graph-canvas", graph);

// 主题切换
function toggleTheme() {
  const html = document.documentElement;
  html.dataset.theme = html.dataset.theme === "dark" ? "light" : "dark";
}

// 配置面板
function toggleConfig() {
  document.getElementById("configPanel").classList.toggle("show");
}

function saveConfig() {
  const config = {
    apiKey: document.getElementById("apiKey").value,
    baseUrl: document.getElementById("baseUrl").value,
    model: document.getElementById("model").value,
    customModel: document.getElementById("customModel").value
  };
  localStorage.setItem("aiWorkflowConfig", JSON.stringify(config));
  alert("配置已保存");
}

// 加载保存的配置
window.addEventListener("load", () => {
  const saved = localStorage.getItem("aiWorkflowConfig");
  if (saved) {
    const c = JSON.parse(saved);
    document.getElementById("apiKey").value = c.apiKey || "";
    document.getElementById("baseUrl").value = c.baseUrl || "https://api.openai.com/v1";
    document.getElementById("model").value = c.model || "gpt-4o";
    document.getElementById("customModel").value = c.customModel || "";
  }
});

// ==================== 自定义节点 ====================

// 基础文本输入节点（故事大纲 / 剧本）
class StoryInputNode extends LGraphNode {
  static title = "故事大纲";
  constructor() {
    super();
    this.addWidget("text", "标题", "我的短剧");
    this.addWidget("textarea", "大纲", "一个女孩在雨中遇到旧爱，两人重逢却发现彼此都变了...");
    this.addOutput("text", "string");
    this.size = [320, 180];
  }
  onExecute() {
    const text = this.widgets[1].value;
    this.setOutputData(0, text);
  }
}
LiteGraph.registerNodeType("shortdrama/story", StoryInputNode);

// 分镜生成节点（调用 LLM 拆分镜头）
class ShotBreakdownNode extends LGraphNode {
  static title = "分镜拆解";
  constructor() {
    super();
    this.addInput("script", "string");
    this.addWidget("button", "拆分", null, ()=>{});
    this.addOutput("shots", "array");
    this.addOutput("prompts", "array");
    this.size = [300, 140];
    this.result = "";
  }
  async onExecute() {
    const script = this.getInputData(0);
    if (!script) return;

    const config = JSON.parse(localStorage.getItem("aiWorkflowConfig") || "{}");
    if (!config.apiKey) return alert("请先配置 API Key");

    const model = config.model === "custom" ? config.customModel : config.model;
    const url = config.baseUrl + (config.baseUrl.endsWith("/") ? "" : "/") + "chat/completions";

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${config.apiKey}`
        },
        body: JSON.stringify({
          model: model || "gpt-4o",
          messages: [
            {role: "system", content: "你是专业短剧导演